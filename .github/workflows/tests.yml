name: CI/CD Pipeline with Best Practices

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    test: 
        runs-on: ubuntu-20.04
        steps: 
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Cache Docker layers
              uses: actions/cache@v3
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            - name: Install Docker Compose
              run: |
                  sudo apt-get update
                  sudo apt-get install -y docker-compose

            - name: Build application
              run: docker-compose -f ./DevOps/lab3/docker-compose.yml up -d --build app

            - name: Test application
              run: docker compose up -d --build tests
    deploy:
        needs: test
        runs-on: ubuntu-20.04
        steps: 
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Cache Docker layers
              uses: actions/cache@v3
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            - name: Install Docker Compose
              run: |
                  sudo apt-get update
                  sudo apt-get install -y docker-compose

            - name: Deploy application
              run: |
                  docker-compose -f ./DevOps/lab3/docker-compose.yml down
                  docker-compose -f ./DevOps/lab3/docker-compose.yml up -d --build tests
              env:
                  DOCKER_BUILDKIT: 1
                  COMPOSE_DOCKER_CLI_BUILD: 1